name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install lint deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff
      - name: Lint (syntax/undefined-name gate)
        run: |
          ruff check --select E9,F63,F7,F82 .

  tests:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: "${{ github.workspace }}/src"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy pandas scikit-learn pytest torch --index-url https://download.pytorch.org/whl/cpu
      - name: Run tests (skips heavy deps)
        run: |
          pytest tests -q
      - name: Smoke fusion flow
        run: |
          python scripts/ci_smoke.py
      - name: Smoke orchestration stubs (best-effort)
        run: |
          python - <<'PY'
import os
os.environ["PYTHONPATH"] = f"{os.getcwd()}/src"
from orchestration.fraud_flow import fraud_pipeline
from orchestration.cyber_flow import cyber_pipeline
from orchestration.behavior_flow import behavior_pipeline
from orchestration.fusion_flow import fusion_pipeline

def safe_run(name, fn):
    try:
        print(f"[ci] running {name}")
        fn()
        print(f"[ci] {name} succeeded")
    except Exception as exc:
        # Do not fail CI on these best-effort smokes
        print(f"[ci] {name} skipped/failed: {exc}")

safe_run("fraud_pipeline", fraud_pipeline)
safe_run("cyber_pipeline", cyber_pipeline)
safe_run("behavior_pipeline", behavior_pipeline)
safe_run("fusion_pipeline", fusion_pipeline)
print("[ci] orchestration stubs best-effort smoke completed")
PY
